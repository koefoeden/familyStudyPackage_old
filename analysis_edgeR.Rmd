---
title: "Transcriptome analysis of the `r params$tissue`-biopsies from the QTL family cohort"
author: 
- "Analysis by Thomas Gade Koefoed"
- "Research assistant, Hansen Group"
- "Novo Nordisk Foundation Center For Basic Metabolic Research"
- "thomas.koefoed@sund.ku.dk"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
   html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    df_print: kable
params:
  genome: human
  genes: NCBI
  tissue: fat
  exclude: none
  report_name: edgeR
editor_options:
  chunk_output_type: inline
---
# Pre-processing {.tabset}
## Setup
```{r setup, warning=FALSE, message=FALSE, results="hide"}
library("tidyverse") # general data manipulation

data_dir <- stringr::str_glue("{params$report_name}_data/")
dir.create(data_dir, showWarnings = F)

suppressPackageStartupMessages({
  library('biomaRt') # downloading gene data
  library("DT") # for pretty printing of paged tables
  library("edgeR") # differential expression analysis
  library("here") # Better structure and relative paths
  
  if(params$genome == "human") {library("org.Hs.eg.db")
  } else if (params$genome == "mouse") {library("org.Mm.eg.db")
  } else if (params$genome == "rat") {library("org.Rn.eg.db")}
  
  library("ggrepel") 
  library("here") # better path management
  library("cbmr") # in-house convenience functions
  library("plotly") # interactive plots
})
i_am("DESCRIPTION")
devtools::load_all(here())
theme_set(theme_bw())
```

## Project specific data loading and formattings {.tabset}
### Create metadata framework from Salmon data
```{r}
combined_pheno_data <- get_combined_pheno_data()
combined_pheno_data_single_tissue <- combined_pheno_data %>% 
  filter(Tissue_fixed == params$tissue) %>% 
  filter(sourceId!="641-9") %>% 
  filter(WH_risk=="High")
```

## DGE list creation for all samples

```{r, message = FALSE, class.source = 'fold-show'}
rna_counts_unordered <- get_rna_counts()
rna_counts <- rna_counts_unordered[,as.character(combined_pheno_data_single_tissue$Salmon.ID.raw)]
y_all <- DGEList(rna_counts, 
                 samples=combined_pheno_data_single_tissue)

log_cpm_all <- cpm(y_all, log=T) 
log_cpm_df_all <- log_cpm_all %>% as.data.frame() %>%  
  rownames_to_column("Name")

cpm_all <- cpm(y_all) 
cpm_df_all <- cpm_all %>% as.data.frame() %>%  
  rownames_to_column("Name")



design_all <-  model.matrix(object = ~BIGG_SI_t_0_60_120, 
                            data=y_all$samples, 
                            na.action="na.pass")

idx_expressed_all <- filterByExpr(y_all, design = design_all) 


y_all <- y_all[idx_expressed_all,] %>% 
  calcNormFactors() %>%
  estimateDisp(design=design_all)
```

## Session info

```{r}
sessionInfo()
```


# Analysis Code {.tabset}

## EdgeR all

```{r}
colnames(design_all) <- make.names(colnames(design_all))

fit_all <- glmQLFit(y_all, design = design_all, robust = TRUE)

coefficients <- design_all %>% 
  colnames() %>% 
  `[`(-1) %>% 
  set_names()

DE_genes_test_all <- coefficients %>% 
  purrr::map(~edgeR_tester(coef = .x, 
                           efit = fit_all, 
                           id_name = case_when(params$genes=="NCBI" ~"Name",
                                               params$genes=="ENSEMBL" ~"ENSEMBL_ID")))
```

## Save R-files
```{r}
saveRDS(y_all, file.path(data_dir,"y_all.RDS"))
saveRDS(DE_genes_test_all, file.path(data_dir,"DE_genes_test_all.RDS"))
saveRDS(fit_all, file.path(data_dir,"fit_all.RDS"))
```

## Write tables
```{r}

```

# Results

## Summary
```{r, warning=F}
coefficient_count <- 1
summary_table <- map(list("Differentially expressed genes (FDR < 5%)"=DE_genes_test_all), 
                     n_sig_genes_pr_contrast) %>% 
  bind_rows(.id="Analysis") %>% knitr::kable()
summary_table
```

## `r coefficients[coefficient_count]` {.tabset}
### Differential gene expression analysis {.tabset}
#### Significant genes (FDR<0.05)
```{r, cache=FALSE, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  dplyr::filter(FDR<0.05) %>% 
  get_DE_datatable_updated()
```

#### All genes (FDR<0.05)
```{r, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  get_DE_datatable_updated()
```
#### Volcano plot
```{r}
DE_genes_test_all[[coefficient_count]] %>%
  ggplot_volcano_updated()

coefficient_count <- coefficient_count+1
if (coefficient_count > length(coefficients)) {knitr::knit_exit()}
```

## `r coefficients[coefficient_count]` {.tabset}
### Differential gene expression analysis {.tabset}
#### Significant genes (FDR<0.05)
```{r, cache=FALSE, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  dplyr::filter(FDR<0.05) %>% 
  get_DE_datatable_updated()
```

#### All genes (FDR<0.05)
```{r, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  get_DE_datatable_updated()
```
#### Volcano plot
```{r}
DE_genes_test_all[[coefficient_count]] %>%
  ggplot_volcano_updated()

coefficient_count <- coefficient_count+1
if (coefficient_count > length(coefficients)) {knitr::knit_exit()}
```

## `r coefficients[coefficient_count]` {.tabset}
### Differential gene expression analysis {.tabset}
#### Significant genes (FDR<0.05)
```{r, cache=FALSE, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  dplyr::filter(FDR<0.05) %>% 
  get_DE_datatable_updated()
```

#### All genes (FDR<0.05)
```{r, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  get_DE_datatable_updated()
```
#### Volcano plot
```{r}
DE_genes_test_all[[coefficient_count]] %>%
  ggplot_volcano_updated()

coefficient_count <- coefficient_count+1
if (coefficient_count > length(coefficients)) {knitr::knit_exit()}
```

## `r coefficients[coefficient_count]` {.tabset}
### Differential gene expression analysis {.tabset}
#### Significant genes (FDR<0.05)
```{r, cache=FALSE, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  dplyr::filter(FDR<0.05) %>% 
  get_DE_datatable_updated()
```

#### All genes (FDR<0.05)
```{r, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  get_DE_datatable_updated()
```
#### Volcano plot
```{r}
DE_genes_test_all[[coefficient_count]] %>%
  ggplot_volcano_updated()

coefficient_count <- coefficient_count+1
if (coefficient_count > length(coefficients)) {knitr::knit_exit()}
```

## `r coefficients[coefficient_count]` {.tabset}
### Differential gene expression analysis {.tabset}
#### Significant genes (FDR<0.05)
```{r, cache=FALSE, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  dplyr::filter(FDR<0.05) %>% 
  get_DE_datatable_updated()
```

#### All genes (FDR<0.05)
```{r, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  get_DE_datatable_updated()
```
#### Volcano plot
```{r}
DE_genes_test_all[[coefficient_count]] %>%
  ggplot_volcano_updated()

coefficient_count <- coefficient_count+1
if (coefficient_count > length(coefficients)) {knitr::knit_exit()}
```

## `r coefficients[coefficient_count]` {.tabset}
### Differential gene expression analysis {.tabset}
#### Significant genes (FDR<0.05)
```{r, cache=FALSE, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  dplyr::filter(FDR<0.05) %>% 
  get_DE_datatable_updated()
```

#### All genes (FDR<0.05)
```{r, warning=FALSE}
DE_genes_test_all[[coefficient_count]] %>% 
  get_DE_datatable_updated()
```
#### Volcano plot
```{r}
DE_genes_test_all[[coefficient_count]] %>%
  ggplot_volcano_updated(genes = get_interesting_genes())

coefficient_count <- coefficient_count+1
if (coefficient_count > length(coefficients)) {knitr::knit_exit()}
```
